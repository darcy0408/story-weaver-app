name: Environment Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate-backend-env:
    name: Validate Backend Environment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Validate .env.example completeness
      run: |
        cd backend
        python -c "
        import os
        import re
        from pathlib import Path

        # Read requirements.txt to get expected packages
        requirements = set()
        if Path('requirements.txt').exists():
            with open('requirements.txt', 'r') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#'):
                        # Extract package name (before any version specifiers)
                        pkg = re.split(r'[>=<~!]', line)[0].strip()
                        requirements.add(pkg.lower())

        # Check if .env.example exists
        if not Path('.env.example').exists():
            print('âŒ .env.example file is missing')
            exit(1)

        # Read .env.example
        with open('.env.example', 'r') as f:
            env_content = f.read()

        # Check for common required environment variables
        required_vars = [
            'FLASK_ENV',
            'SECRET_KEY',
            'DATABASE_URL',
            'GEMINI_API_KEY',
            'OPENROUTER_API_KEY'
        ]

        missing_vars = []
        for var in required_vars:
            if var not in env_content:
                missing_vars.append(var)

        if missing_vars:
            print(f'âŒ Missing required environment variables in .env.example: {missing_vars}')
            exit(1)

        print('âœ… .env.example contains all required environment variables')
        "

    - name: Check backend configuration
      run: |
        cd backend
        python -c "
        import sys
        import importlib.util

        # Try to import main app module
        try:
            spec = importlib.util.spec_from_file_location('app', 'app.py')
            app_module = importlib.util.module_from_spec(spec)
            spec.loader.exec_module(app_module)
            print('âœ… Backend app.py imports successfully')
        except Exception as e:
            print(f'âŒ Backend app.py has import errors: {e}')
            sys.exit(1)

        # Check if Flask app can be created
        try:
            app = app_module.create_app()
            print('âœ… Flask app can be created')
        except Exception as e:
            print(f'âŒ Cannot create Flask app: {e}')
            sys.exit(1)
        "

  validate-frontend-env:
    name: Validate Frontend Environment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.8.1'
        channel: 'stable'

    - name: Check Flutter version
      run: flutter --version

    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Analyze Flutter code
      run: flutter analyze

    - name: Check Flutter configuration
      run: |
        # Check if pubspec.yaml has required dependencies
        if ! grep -q "http:" pubspec.yaml; then
          echo "âŒ HTTP dependency missing in pubspec.yaml"
          exit 1
        fi

        if ! grep -q "shared_preferences:" pubspec.yaml; then
          echo "âŒ Shared preferences dependency missing in pubspec.yaml"
          exit 1
        fi

        echo "âœ… Flutter dependencies are properly configured"

    - name: Validate Flutter project structure
      run: |
        # Check for required directories
        required_dirs=('lib' 'test' 'android' 'ios' 'web')
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "âŒ Required directory '$dir' is missing"
            exit 1
          fi
        done

        # Check for main.dart
        if [ ! -f "lib/main.dart" ]; then
          echo "âŒ lib/main.dart is missing"
          exit 1
        fi

        # Check for pubspec.yaml
        if [ ! -f "pubspec.yaml" ]; then
          echo "âŒ pubspec.yaml is missing"
          exit 1
        fi

        echo "âœ… Flutter project structure is valid"

  validate-scripts:
    name: Validate Setup Scripts
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate setup script
      run: |
        # Check if setup script exists and is executable
        if [ ! -f "scripts/setup-dev-env.sh" ]; then
          echo "âŒ scripts/setup-dev-env.sh is missing"
          exit 1
        fi

        if [ ! -x "scripts/setup-dev-env.sh" ]; then
          echo "âŒ scripts/setup-dev-env.sh is not executable"
          exit 1
        fi

        # Basic syntax check
        bash -n scripts/setup-dev-env.sh
        if [ $? -ne 0 ]; then
          echo "âŒ scripts/setup-dev-env.sh has syntax errors"
          exit 1
        fi

        echo "âœ… Setup script is valid and executable"

  environment-summary:
    name: Environment Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-backend-env, validate-frontend-env, validate-scripts]

    steps:
    - name: Environment validation complete
      run: |
        echo "ðŸŽ‰ All environment validations passed!"
        echo ""
        echo "âœ… Backend environment validated"
        echo "âœ… Frontend environment validated"
        echo "âœ… Setup scripts validated"
        echo ""
        echo "The development environment is properly configured."